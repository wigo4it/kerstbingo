<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techorama 2024</title>
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/icons/site.webmanifest">
    <link rel="stylesheet" href="game.css">
</head>

<body>
    <button id="button">Win een CO2 meter!</button>
    <div id="textBox"></div>
    <canvas id="confetti" style="display:none;"></canvas>
    <audio id="wachtMuziekje" src="assets/wachtMuziekje.mp3"></audio>
    <audio id="winnaar" src="assets/winnaar.mp3"></audio>

    <script src="confetti.js"></script>
    <script>
        const button = document.getElementById('button');
        const textBox = document.getElementById('textBox');
        const wachtMuziekje = document.getElementById('wachtMuziekje');
        const winnaar = document.getElementById('winnaar');
        const confetti = document.getElementById('confetti');
        let names = [];

        // Functie om namen te schudden
        const shuffle = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };

        // Functie om te handelen na een klik
        async function handleAction() {
            textBox.classList.remove('final-name');
            button.classList.remove('rotate');
            void button.offsetWidth; // Forceer een reflow
            button.classList.add('rotate');
            wachtMuziekje.play();

            try {
                const response = await fetch('/api/deelnemers');
                if (!response.ok) throw new Error('Network response was not ok');
                names = await response.json();

                const goldenTicketResponse = await fetch('/api/goldenticketstatus');
                if (!goldenTicketResponse.ok) throw new Error('Network response was not ok');
                const goldenTicket = await goldenTicketResponse.json();
                if (!goldenTicket.isdrawn) names.push('Golden Ticket!');

                shuffle(names);
                let currentIndex = 0;
                const interval = setInterval(() => {
                    textBox.textContent = names[currentIndex];
                    currentIndex = (currentIndex + 1) % names.length;
                }, 300);

                setTimeout(async () => {
                    clearInterval(interval);
                    textBox.classList.add('final-name');
                    confetti.style.display = 'block';
                    const winnerResponse = await fetch('/api/draw');
                    if (!winnerResponse.ok) throw new Error('Network response was not ok');
                    const winner = await winnerResponse.text();

                    winnaar.play();
                    setTimeout(() => {
                        wachtMuziekje.pause();
                        wachtMuziekje.currentTime = 0;
                        location.reload();
                    }, 5000);
                }, 5020);
            } catch (error) {
                console.error(error);
            }
        }

        button.addEventListener('click', handleAction);
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') handleAction();
        });
    </script>
</body>

</html>