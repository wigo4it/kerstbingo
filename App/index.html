<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techorama 2024</title>
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/icons/site.webmanifest">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="stylesheet" href="game.css">
</head>

<body>
    <button id="button">Win een CO2 meter!</button>
    <div id="textBox"></div>
    <canvas id="confetti"></canvas>
    <audio id="wachtMuziekje" src="assets/wachtMuziekje.mp3" type="audio/mp3"></audio>
    <audio id="winnaar" src="assets/winnaar.mp3" type="audio/mp3"></audio>

    <script src="confetti.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.getElementById('button');
            const textBox = document.getElementById('textBox');
            const audioElement = document.getElementById('wachtMuziekje');

            // Function to shuffle the names array
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // Function to handle the action
            async function handleAction() {
                textBox.classList.remove('final-name');
                this.classList.remove('rotate');
                void this.offsetWidth;
                this.classList.add('rotate');

                // Play the audio
                audioElement.play();

                // Stop the audio after 10 seconds
                document.getElementById('confetti').style.display = 'none';

                // Fetch deelnemers en golden ticket status binnen deze functie
                let names = [];
                let goldenTicket = { isdrawn: true }; // Default value

                try {
                    const response = await fetch('/api/deelnemers', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    names = await response.json();

                    const goldenTicketResponse = await fetch('/api/goldenticketstatus', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!goldenTicketResponse.ok) {
                        throw new Error('Network response was not ok');
                    }
                    goldenTicket = await goldenTicketResponse.json();

                    // Als het gouden ticket niet getrokken is (isdrawn is false), voeg het toe aan de lijst
                    if (!goldenTicket.isdrawn) {
                        names.push('Golden Ticket!');
                    }
                } catch (error) {
                    console.error(error);
                }

                shuffle(names); // Shuffle the names before displaying them randomly

                let currentIndex = 0;
                const intervalTime = 300;
                const totalTime = 5020;

                const interval = setInterval(() => {
                    if (names.length > 0) {
                        textBox.style.color = ''; // Reset to default color

                        if (!goldenTicket.isdrawn) {
                            textBox.textContent = names[currentIndex];
                        } else {
                            textBox.textContent = "Coin";
                        }
                        currentIndex = (currentIndex + 1) % names.length;
                    }
                }, intervalTime);

                setTimeout(() => {
                    clearInterval(interval);
                    textBox.style.color = 'red';
                    textBox.classList.add('final-name');
                    document.getElementById('confetti').style.display = 'block';
                    document.getElementById('winnaar').play();
                    setTimeout(() => {
                        audioElement.pause();
                        audioElement.currentTime = 0; // Reset the audio to the beginning
                        //window.location.reload(); // Reload the page after 5 seconds
                    }, 5000); // 5000 milliseconds = 5 seconds
                    this.classList.remove('rotate');
                }, totalTime);
            }

            // Add event listener for the button click
            button.addEventListener('click', handleAction);
        });
    </script>
</body>

</html>
