<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techorama 2024</title>
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="game.css">
</head>

<body>
    <button id="button">Win een CO2 meter!</button>
    <div id="textBox"></div>
    <canvas id="confetti" style="display:none;"></canvas>
    <audio id="wachtMuziekje" src="assets/wachtMuziekje.mp3" type="audio/mp3"></audio>
    <audio id="winnaar" src="assets/winnaar.mp3" type="audio/mp3"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const button = document.getElementById('button');
            const textBox = document.getElementById('textBox');
            const audioElement = document.getElementById('wachtMuziekje');
            let names = [];

            // Deelnemerslijst ophalen
            try {
                const response = await fetch('/api/deelnemers', { method: 'GET' });
                if (!response.ok) throw new Error('Netwerkfout bij ophalen deelnemers');
                names = await response.json();

                // Status van het gouden ticket controleren
                const goldenTicketResponse = await fetch('/api/goldenticketstatus', { method: 'GET' });
                if (!goldenTicketResponse.ok) throw new Error('Netwerkfout bij status gouden ticket');
                const { isdrawn } = await goldenTicketResponse.json();
                if (!isdrawn) names.push('Golden Ticket!');
            } catch (error) {
                console.error(error.message);
            }

            // Namen schudden en weergeven
            button.addEventListener('click', () => handleAction(names, textBox, audioElement));
        });

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function handleAction(names, textBox, audioElement) {
            shuffle(names);
            textBox.classList.remove('final-name');
            this.classList.add('rotate');
            audioElement.play();

            let currentIndex = 0;
            const interval = setInterval(() => {
                textBox.textContent = names[currentIndex];
                currentIndex = (currentIndex + 1) % names.length;
            }, 300);

            // Wacht op de trekking
            setTimeout(async () => {
                clearInterval(interval);
                textBox.classList.add('final-name');
                const response = await fetch('/api/draw', { method: 'GET' });
                const winner = await response.text() || "Geen winnaar";
                textBox.textContent = winner;
                document.getElementById('confetti').style.display = 'block';
                document.getElementById('winnaar').play();

                // Audio resetten en pagina herladen
                setTimeout(() => {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                    window.location.reload();
                }, 5000);
            }, 5020);
        }
    </script>
</body>
</html>